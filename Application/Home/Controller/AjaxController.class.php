<?phpnamespace Home\Controller;use User\Api\UserApi;use Admin\Model\PictureModel;class AjaxController extends HomeController {    public function ajGetGoods(){        if(IS_AJAX){            $page = I('get.p','','intval');            $where['state'] = 1;            $sort_id = I('get.id','','intval');            if($sort_id>0){                $where['sort_id'] = $sort_id;            }            $once = I('get.once','','intval');            $once = ($once>0 && $once<=40)?$once:0;            $count = M('goods')->where($where)->count();            $goods = D('Goods')->getGoodsList($this->iniPage($count),$where);            if($goods){                $this->assign('goods',$goods);                $this->assign('page',$page+1);            }            $this->display();        }    }        public function ajGetGoodsDetial(){        if(IS_AJAX){            $url = I('get.url');            $data = file_get_contents($url);            preg_match('/dsc\.taobaocdn\.com[\w\.\%\/]*[\"]/i', $data,$descurl);            $descurl = "http://".trim($descurl[0],'"');            $content = file_get_contents($descurl);            //$json['state'] = $json['content']?1:0;            if($content){                $content = mb_convert_encoding($content, 'utf-8', 'GBK,UTF-8,ASCII');                $where['item_url'] = htmlspecialchars_decode($url);                $save['item_body'] = trim($content,"var desc='");                $save['item_body'] = substr($save['item_body'],0,-3);                M('goods')->where($where)->save($save);            }else{                $this->ajaxReturn("商品详情获取失败，请刷新重试");            }            $this->assign('content',$content);            $this->display();        }    }        public function favor(){        $this->isLogin();        if(IS_AJAX){            $data['goods_id'] = I('get.id','','intval');            $data['uid'] = $this->my['uid'];            if(M('favor')->where($data)->find()){                $json['state'] = 1;                $json['info'] = "已经收藏过了";                $this->ajaxReturn($json);            }            if(M('favor')->add($data)){                $json['state'] = 1;                $json['info'] = "收藏成功";            }else{                $json['state'] = 0;                $json['info'] = "收藏失败";            }            $this->ajaxReturn($json);        }    }    public function login(){        if(IS_POST){            /* 调用UC登录接口登录 */            $username = I("username");            $password = I("password");            $user = new UserApi;            $uid = $user->login($username, $password);            if(0 < $uid){ //UC登录成功                /* 登录用户 */                $Member = D('Member');                if($Member->login($uid)){ //登录用户                    //TODO:跳转到登录前页面                    $json['state'] = 1;                    $json['info'] = "登录成功！";                    // $this->success('登录成功！',U('Home/Index/index'));                                    } else {                    $json['state'] = 0;                    $json['info'] = $Member->getError();                    // $this->error($Member->getError());                }             } else { //登录失败                switch($uid) {                    case -1: $error = '用户不存在或被禁用！'; break; //系统级别禁用                    case -2: $error = '密码错误！'; break;                    default: $error = '未知错误！'; break; // 0-接口参数错误（调试阶段使用）                }                // $this->error($error);                $json['state'] = 0;                $json['info'] = $error;            }            $this->ajaxReturn($json);        }else {            $this->display();        }    }    /**     * 上传图片     * @author huajie <banhuajie@163.com>     */    public function uploadPicture(){        //TODO: 用户登录检测        /* 返回标准数据 */        $return  = array('status' => 1, 'info' => '上传成功', 'data' => '');        /* 调用文件上传组件上传文件 */        $Picture = new PictureModel();        $pic_driver = C('PICTURE_UPLOAD_DRIVER');        $info = $Picture->upload(            $_FILES,            C('PICTURE_UPLOAD'),            C('PICTURE_UPLOAD_DRIVER'),            C("UPLOAD_{$pic_driver}_CONFIG")        ); //TODO:上传到远程服务器        /* 记录图片信息 */        if($info){            $dd = getimagesize($_FILES["download"]["tmp_name"]);            $return['status'] = 1;            $return["width"] = $dd[0];            $return["height"] = $dd[1];            $return = array_merge($info['download'], $return);        } else {            $return['status'] = 0;            $return['info']   = $Picture->getError();        }        /* 返回JSON数据 */        $this->ajaxReturn($return);    }}